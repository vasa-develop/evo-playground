<!DOCTYPE html>
<html>
<head>
    <title>FermiNet MCMC Sampling Visualization</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 40px);
        }
        .plot {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: #333;
            pointer-events: none;
            z-index: 1000;
        }
        .control-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        button, select {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f0f0f0;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="info">FermiNet MCMC Sampling Visualization</div>
    <div class="control-panel">
        <div class="slider-container">
            <label for="walkers">Number of Walkers: <span id="walkersValue">50</span></label>
            <input type="range" id="walkers" min="10" max="100" value="50">
        </div>
        <div class="slider-container">
            <label for="temperature">Temperature (K): <span id="temperatureValue">300</span></label>
            <input type="range" id="temperature" min="100" max="1000" value="300">
        </div>
        <button onclick="resetSimulation()">Reset Simulation</button>
        <button onclick="toggleAnimation()" id="animationButton">Pause</button>
    </div>
    <div class="container">
        <div id="trajectoryPlot" class="plot"></div>
        <div id="acceptancePlot" class="plot"></div>
    </div>
    <script>
        let animationId;
        let isAnimating = true;
        let currentStep = 0;
        let acceptanceHistory = [];
        let walkerPositions = [];
        const maxHistoryLength = 100;

        // Initialize walker positions
        function initializeWalkers(numWalkers) {
            walkerPositions = [];
            for (let i = 0; i < numWalkers; i++) {
                walkerPositions.push({
                    x: [],
                    y: [],
                    z: []
                });
            }
        }

        // Generate new walker positions using Metropolis-Hastings
        function updateWalkers(temperature) {
            const stepSize = 0.1;
            let accepted = 0;
            const beta = 1 / (temperature * 8.617333262145e-5); // Boltzmann constant in eV/K

            walkerPositions.forEach(walker => {
                // Get current position or initialize
                let x = walker.x.length > 0 ? walker.x[walker.x.length - 1] : (Math.random() - 0.5) * 2;
                let y = walker.y.length > 0 ? walker.y[walker.y.length - 1] : (Math.random() - 0.5) * 2;
                let z = walker.z.length > 0 ? walker.z[walker.z.length - 1] : (Math.random() - 0.5) * 2;

                // Propose new position
                const newX = x + (Math.random() - 0.5) * stepSize;
                const newY = y + (Math.random() - 0.5) * stepSize;
                const newZ = z + (Math.random() - 0.5) * stepSize;

                // Calculate acceptance probability (using a simple harmonic potential)
                const oldEnergy = (x*x + y*y + z*z) / 2;
                const newEnergy = (newX*newX + newY*newY + newZ*newZ) / 2;
                const deltaE = newEnergy - oldEnergy;


                if (Math.random() < Math.exp(-beta * deltaE)) {
                    x = newX;
                    y = newY;
                    z = newZ;
                    accepted++;
                }

                // Update walker history
                walker.x.push(x);
                walker.y.push(y);
                walker.z.push(z);

                // Limit history length
                if (walker.x.length > maxHistoryLength) {
                    walker.x.shift();
                    walker.y.shift();
                    walker.z.shift();
                }
            });

            // Calculate acceptance rate
            const acceptanceRate = accepted / walkerPositions.length;
            acceptanceHistory.push(acceptanceRate);
            if (acceptanceHistory.length > maxHistoryLength) {
                acceptanceHistory.shift();
            }

            return acceptanceRate;
        }

        // Update plots
        function updatePlots() {
            // Update trajectory plot
            const trajectoryData = walkerPositions.map((walker, i) => ({
                type: 'scatter3d',
                mode: 'lines',
                x: walker.x,
                y: walker.y,
                z: walker.z,
                name: `Walker ${i+1}`,
                line: {
                    width: 2,
                    color: `hsl(${(i * 360 / walkerPositions.length)}, 70%, 50%)`
                }
            }));

            const trajectoryLayout = {
                title: 'Walker Trajectories',
                scene: {
                    xaxis: { title: 'X Position' },
                    yaxis: { title: 'Y Position' },
                    zaxis: { title: 'Z Position' }
                },
                margin: { t: 50 }
            };

            Plotly.newPlot('trajectoryPlot', trajectoryData, trajectoryLayout);

            // Update acceptance rate plot
            const steps = Array.from({length: acceptanceHistory.length}, (_, i) => i);
            const acceptanceData = [{
                type: 'scatter',
                mode: 'lines',
                x: steps,
                y: acceptanceHistory,
                name: 'Acceptance Rate',
                line: { color: 'blue' }
            }];

            const acceptanceLayout = {
                title: 'MCMC Acceptance Rate',
                xaxis: { title: 'Step' },
                yaxis: {
                    title: 'Acceptance Rate',
                    range: [0, 1]
                },
                margin: { t: 50 }
            };

            Plotly.newPlot('acceptancePlot', acceptanceData, acceptanceLayout);
        }

        // Animation loop
        function animate() {
            if (!isAnimating) return;

            const temperature = parseInt(document.getElementById('temperature').value);
            updateWalkers(temperature);
            updatePlots();
            currentStep++;

            animationId = requestAnimationFrame(animate);
        }

        // UI Controls
        function resetSimulation() {
            const numWalkers = parseInt(document.getElementById('walkers').value);
            currentStep = 0;
            acceptanceHistory = [];
            initializeWalkers(numWalkers);
            updatePlots();
        }

        function toggleAnimation() {
            isAnimating = !isAnimating;
            const button = document.getElementById('animationButton');
            button.textContent = isAnimating ? 'Pause' : 'Resume';
            if (isAnimating) {
                animate();
            } else {
                cancelAnimationFrame(animationId);
            }
        }

        // Update UI values
        document.getElementById('walkers').addEventListener('input', function(e) {
            document.getElementById('walkersValue').textContent = e.target.value;
        });

        document.getElementById('temperature').addEventListener('input', function(e) {
            document.getElementById('temperatureValue').textContent = e.target.value;
        });

        // Initialize
        resetSimulation();
        animate();

        // Handle window resize
        window.addEventListener('resize', updatePlots);
    </script>
</body>
</html>
